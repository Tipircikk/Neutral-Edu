
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Kullanıcı profilleri:
    // - Herkes kendi profilini okuyabilir ve yazabilir.
    // - Adminler tüm profilleri okuyabilir ve yazabilir.
    match /users/{userId} {
      allow read, update, delete: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      allow create: if request.auth.uid == userId; // Yeni kullanıcılar kendi profillerini oluşturabilir
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true; // Sadece adminler tüm kullanıcıları listeleyebilir
    }

    // Destek Talepleri
    match /supportTickets/{ticketId} {
      allow read, update: if request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      allow create: if request.auth.uid != null; // Giriş yapmış herkes talep oluşturabilir
      allow list: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true; // Sadece adminler tüm talepleri listeleyebilir

      // Destek Talebi Mesajları
      match /messages/{messageId} {
        allow read: if request.auth.uid == get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
        allow create: if request.auth.uid == get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
        // Mesaj güncelleme/silme genellikle yapılmaz, gerekirse eklenebilir.
      }
    }

    // Fiyatlandırma Konfigürasyonu
    match /pricingConfig/{configId} {
      allow read: if true; // Herkes fiyatları okuyabilir
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true; // Sadece adminler fiyatları güncelleyebilir
    }

    // Uygulama Konfigürasyonu (Sınav Tarihleri vb.)
    match /appConfig/{configId} {
      allow read: if true; // Herkes uygulama konfigürasyonunu okuyabilir (örn: sınav tarihleri)
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true; // Sadece adminler güncelleyebilir
    }
  }
}
