
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users Collection
    match /users/{userId} {
      // Authenticated users can read and update their own profile.
      // They can also create their profile during signup.
      // Admins can also read any user profile (covered by the broader admin rule below).
      allow read, update, create: if request.auth.uid == userId;

      // Admins can perform any action on any user document (get, list, create, update, delete).
      // The 'read' permission here covers 'get' and 'list'.
      // The 'write' permission covers 'create', 'update', 'delete'.
      allow read, write: if get(/databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // SupportTickets Collection
    match /supportTickets/{ticketId} {
      // Authenticated users can create tickets, ensuring they are the owner.
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      
      // Users can read and update their own tickets (e.g., to check status or add comments if allowed).
      // Admins can also read/update any ticket (covered by the broader admin rule below).
      allow read, update: if request.auth.uid == resource.data.userId;
      
      // Admins can perform any action on any support ticket.
      // 'read' includes 'get' and 'list'.
      // 'write' includes 'create', 'update', 'delete'.
      allow read, write: if get(/databases/(default)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
  }
}
